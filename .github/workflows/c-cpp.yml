name: C/C++ CI
permissions:
  contents: read
  pull-requests: write

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      CC: clang
      CXX: clang++

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Install build dependencies
      run: |
        export DEBIAN_FRONTEND=noninteractive
        sudo dpkg --add-architecture i386
        sudo apt update
        sudo apt-get install -y --no-install-recommends \
          build-essential curl procps clang lld make binutils \
          libcurl4-openssl-dev libatomic1 libreadline-dev libarchive-dev \
          zlib1g-dev upx-ucl upx \
          libc6:i386 libstdc++6:i386 libcurl4:i386
        sudo apt-get autoremove -y
        sudo apt-get clean

    - name: Build project (Debug configuration)
      run: |
        echo "[TASKS - BUILD] RUNNING DEBUG BUILD"
        make debug
        echo "[TASKS - BUILD] BUILD FILE DETAILS"
        file watchdogs.debug

    - name: Execute test suite and validation
      run: |
        echo "[TASKS - BUILD] TESTING HELP COMMAND"
        ./watchdogs.debug help
        echo "[TASKS - BUILD] TESTING WATCHDOGS COMMAND"
        ./watchdogs.debug watchdogs
        echo "[TASKS - BUILD] CHECKING BINARY DEPENDENCIES"
        ldd watchdogs.debug || true
        exit 0

    - name: Build artifact analysis
      run: |
        echo "[TASKS - BUILD] ARTIFACT STATISTICS"
        ls -la watchdogs.debug
        size watchdogs.debug || true
        echo "[TASKS - BUILD] BUILD COMPLETED SUCCESSFULLY"
