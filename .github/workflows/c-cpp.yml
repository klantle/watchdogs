name: C/C++ CI (Multi-Platform)

permissions:
  contents: read
  pull-requests: write

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-ubuntu:
    name: Build on Ubuntu
    runs-on: ubuntu-latest
    env:
      CC: clang
      CXX: clang++

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Install build dependencies (Ubuntu)
      run: |
        echo "[TASKS] Installing dependencies on Ubuntu"
        export DEBIAN_FRONTEND=noninteractive
        sudo dpkg --add-architecture i386
        sudo apt update
        sudo apt-get install -y --no-install-recommends \
          build-essential curl procps clang lld make binutils \
          libcurl4-openssl-dev libatomic1 libreadline-dev libarchive-dev \
          zlib1g-dev fzf \
          libc6:i386 libstdc++6:i386 libcurl4:i386
        sudo apt-get autoremove -y
        sudo apt-get clean

    - name: Build project (Debug configuration)
      run: |
        echo "[TASKS - BUILD] RUNNING DEBUG BUILD"
        make debug
        echo "[TASKS - BUILD] BUILD FILE DETAILS"
        file watchdogs.debug

    - name: Execute test suite and validation
      run: |
        echo "[TASKS - BUILD] TESTING HELP COMMAND"
        ./watchdogs.debug help
        echo "[TASKS - BUILD] TESTING WATCHDOGS COMMAND"
        ./watchdogs.debug watchdogs
        echo "[TASKS - BUILD] CHECKING BINARY DEPENDENCIES"
        ldd watchdogs.debug || true
        exit 0

    - name: Build artifact analysis
      run: |
        echo "[TASKS - BUILD] ARTIFACT STATISTICS"
        ls -la watchdogs.debug
        size watchdogs.debug || true
        echo "[TASKS - BUILD] BUILD COMPLETED SUCCESSFULLY ON UBUNTU"

  build-fedora:
    name: Build on Fedora
    runs-on: ubuntu-latest
    env:
      CC: clang
      CXX: clang++

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Build using Fedora Docker container
      run: |
        docker run --rm -v $(pwd):/workspace -w /workspace fedora:latest /bin/bash -c "
          if command -v dnf5 >/dev/null 2>&1; then
            echo '[TASKS] Using dnf5 (Fedora 39+)'
            DNF_CMD='dnf5'
          else
            echo '[TASKS] Using dnf (Fedora <= 38)'
            DNF_CMD='dnf'
          fi

          echo '[TASKS] Installing dependencies on Fedora'

          \$DNF_CMD -y update
          \$DNF_CMD -y install @development-tools make file binutils readline

          if [[ \"\$DNF_CMD\" == \"dnf5\" ]]; then
            \$DNF_CMD -y install '@Development Tools'
          else
            \$DNF_CMD -y groupinstall 'Development Tools'
          fi

          \$DNF_CMD -y install \
            clang lld fzf libatomic libcxx-devel curl-devel \
            readline-devel libarchive-devel \
            zlib-devel procps-ng \
            glibc-devel.i686 libstdc++-devel.i686 libcurl-devel.i686

          echo '[TASKS - BUILD] RUNNING DEBUG BUILD'
          make debug

          echo '[TASKS - BUILD] BUILD FILE DETAILS'
          file watchdogs.debug

          echo '[TASKS - BUILD] TESTING HELP COMMAND'
          ./watchdogs.debug help || echo 'Help command test skipped'

          echo '[TASKS - BUILD] TESTING WATCHDOGS COMMAND'
          ./watchdogs.debug watchdogs || echo 'Watchdogs command test skipped'

          echo '[TASKS - BUILD] CHECKING BINARY DEPENDENCIES'
          ldd watchdogs.debug 2>/dev/null || readelf -d watchdogs.debug | grep NEEDED || true

          echo '[TASKS - BUILD] ARTIFACT STATISTICS'
          ls -la watchdogs.debug
          size watchdogs.debug 2>/dev/null || true

          echo '[TASKS - BUILD] BUILD COMPLETED SUCCESSFULLY ON FEDORA'
        "
    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: watchdogs-fedora-debug
        path: watchdogs.debug

  build-almalinux:
    name: Build on AlmaLinux
    runs-on: ubuntu-latest
    env:
      CC: gcc
      CXX: g++

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Build using AlmaLinux Docker container
      run: |
        docker run --rm -v $(pwd):/workspace -w /workspace almalinux:9 /bin/bash -c "
          echo '[TASKS] Installing dependencies on AlmaLinux 9'
          dnf -y update
          dnf -y install epel-release dnf-plugins-core
          dnf config-manager --set-enabled crb
          dnf -y groupinstall 'Development Tools'
          dnf -y install \
            clang lld llvm-toolset libatomic \
            libcurl-devel \
            readline-devel \
            libarchive-devel \
            zlib-devel \
            procps-ng \
            binutils \
            fzf \
            glibc-devel.i686 glibc-devel.x86_64 \
            libstdc++-devel.i686 libstdc++-devel.x86_64

          dnf -y install libcxx-devel 2>/dev/null || echo 'libcxx-devel not available, using default C++ library'

          echo '[TASKS] Checking installed packages'
          rpm -qa | grep -E '(curl|readline|archive|zlib|clang|gcc)' | sort

          echo '[TASKS - BUILD] RUNNING DEBUG BUILD'
          make debug || (echo '[ERROR] Build failed, trying with gcc' && CC=gcc CXX=g++ make debug)

          echo '[TASKS - BUILD] BUILD FILE DETAILS'
          file watchdogs.debug 2>/dev/null || echo 'No binary found'

          if [ -f watchdogs.debug ]; then
            echo '[TASKS - BUILD] TESTING HELP COMMAND'
            ./watchdogs.debug help || echo 'Help command test skipped'

            echo '[TASKS - BUILD] TESTING WATCHDOGS COMMAND'
            ./watchdogs.debug watchdogs || echo 'Watchdogs command test skipped'

            echo '[TASKS - BUILD] CHECKING BINARY DEPENDENCIES'
            ldd watchdogs.debug 2>/dev/null || readelf -d watchdogs.debug | grep NEEDED || true

            echo '[TASKS - BUILD] ARTIFACT STATISTICS'
            ls -la watchdogs.debug
            size watchdogs.debug 2>/dev/null || true

            echo '[TASKS - BUILD] BUILD COMPLETED SUCCESSFULLY ON ALMALINUX 9'
          else
            echo '[ERROR] Build failed completely on AlmaLinux'
            exit 1
          fi
        "
    - name: Upload build artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: watchdogs-almalinux9-debug
        path: watchdogs.debug

  build-rockylinux:
    name: Build on Rocky Linux
    runs-on: ubuntu-latest
    env:
      CC: gcc
      CXX: g++

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Build using Rocky Linux Docker container
      run: |
        docker run --rm -v $(pwd):/workspace -w /workspace rockylinux:9 /bin/bash -c "
          echo '[TASKS] Installing dependencies on Rocky Linux 9'
          dnf -y update
          dnf -y install epel-release dnf-plugins-core
          dnf config-manager --set-enabled crb
          dnf -y groupinstall 'Development Tools'
          dnf -y install \
            clang lld llvm-toolset libatomic \
            libcurl-devel \
            readline-devel \
            libarchive-devel \
            zlib-devel \
            procps-ng \
            fzf \
            binutils \
            glibc-devel.i686 glibc-devel.x86_64 \
            libstdc++-devel.i686 libstdc++-devel.x86_64

          dnf -y install libcxx-devel 2>/dev/null || echo 'libcxx-devel not available, using default C++ library'

          echo '[TASKS] Checking installed packages'
          rpm -qa | grep -E '(curl|readline|archive|zlib|clang|gcc)' | sort

          echo '[TASKS - BUILD] RUNNING DEBUG BUILD'
          make debug || (echo '[ERROR] Build failed, trying with gcc' && CC=gcc CXX=g++ make debug)

          echo '[TASKS - BUILD] BUILD FILE DETAILS'
          file watchdogs.debug 2>/dev/null || echo 'No binary found'

          if [ -f watchdogs.debug ]; then
            echo '[TASKS - BUILD] TESTING HELP COMMAND'
            ./watchdogs.debug help || echo 'Help command test skipped'

            echo '[TASKS - BUILD] TESTING WATCHDOGS COMMAND'
            ./watchdogs.debug watchdogs || echo 'Watchdogs command test skipped'

            echo '[TASKS - BUILD] CHECKING BINARY DEPENDENCIES'
            ldd watchdogs.debug 2>/dev/null || readelf -d watchdogs.debug | grep NEEDED || true

            echo '[TASKS - BUILD] ARTIFACT STATISTICS'
            ls -la watchdogs.debug
            size watchdogs.debug 2>/dev/null || true

            echo '[TASKS - BUILD] BUILD COMPLETED SUCCESSFULLY ON ROCKY LINUX 9'
          else
            echo '[ERROR] Build failed completely on Rocky Linux'
            exit 1
          fi
        "
    - name: Upload build artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: watchdogs-rockylinux9-debug
        path: watchdogs.debug

  build-opensuse:
    name: Build on openSUSE
    runs-on: ubuntu-latest
    env:
      CC: clang
      CXX: clang++

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Build using openSUSE Docker container
      run: |
        docker run --rm -v $(pwd):/workspace -w /workspace opensuse/leap:15 /bin/bash -c "
          echo '[TASKS] Installing dependencies on openSUSE Leap'
          zypper --non-interactive refresh
          zypper --non-interactive install -y -t pattern devel_basis
          zypper --non-interactive install -y \
            curl \
            fzf \
            clang lld llvm \
            libc++-devel \
            libatomic1 \
            libcurl-devel \
            readline-devel \
            libarchive-devel \
            binutils \
            procps

          echo '[TASKS - BUILD] RUNNING DEBUG BUILD'
          make debug

          echo '[TASKS - BUILD] BUILD FILE DETAILS'
          file watchdogs.debug

          echo '[TASKS - BUILD] TESTING HELP COMMAND'
          ./watchdogs.debug help || echo 'Help command test skipped'

          echo '[TASKS - BUILD] TESTING WATCHDOGS COMMAND'
          ./watchdogs.debug watchdogs || echo 'Watchdogs command test skipped'

          echo '[TASKS - BUILD] CHECKING BINARY DEPENDENCIES'
          ldd watchdogs.debug 2>/dev/null || readelf -d watchdogs.debug | grep NEEDED || true

          echo '[TASKS - BUILD] ARTIFACT STATISTICS'
          ls -la watchdogs.debug
          size watchdogs.debug 2>/dev/null || true

          echo '[TASKS - BUILD] BUILD COMPLETED SUCCESSFULLY ON OPENSUSE'
        "
    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: watchdogs-opensuse-debug
        path: watchdogs.debug

  build-arch:
    name: Build on Arch Linux
    runs-on: ubuntu-latest
    env:
      CC: clang
      CXX: clang++

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Build using Arch Linux Docker container
      run: |
        docker run --rm -v $(pwd):/workspace -w /workspace archlinux:base-devel /bin/bash -c "
          echo '[TASKS] Installing dependencies on Arch Linux'
          pacman -Sy --noconfirm
          pacman -S --needed --noconfirm \
            base-devel \
            clang lld llvm libc++ \
            libatomic_ops \
            readline \
            curl \
            fzf \
            libarchive \
            zlib \
            binutils \
            procps-ng \
            lib32-gcc-libs

          echo '[TASKS - BUILD] RUNNING DEBUG BUILD'
          make debug

          echo '[TASKS - BUILD] BUILD FILE DETAILS'
          file watchdogs.debug

          echo '[TASKS - BUILD] TESTING HELP COMMAND'
          ./watchdogs.debug help || echo 'Help command test skipped'

          echo '[TASKS - BUILD] TESTING WATCHDOGS COMMAND'
          ./watchdogs.debug watchdogs || echo 'Watchdogs command test skipped'

          echo '[TASKS - BUILD] CHECKING BINARY DEPENDENCIES'
          ldd watchdogs.debug 2>/dev/null || readelf -d watchdogs.debug | grep NEEDED || true

          echo '[TASKS - BUILD] ARTIFACT STATISTICS'
          ls -la watchdogs.debug
          size watchdogs.debug 2>/dev/null || true

          echo '[TASKS - BUILD] BUILD COMPLETED SUCCESSFULLY ON ARCH LINUX'
        "
    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: watchdogs-archlinux-debug
        path: watchdogs.debug

  build-termux:
    name: Build on Termux (Android)
    runs-on: ubuntu-latest
    env:
      CC: clang
      CXX: clang++

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Build using Termux Docker container
      run: |
        docker run --rm -v $(pwd):/workspace -w /workspace termux/termux-docker /bin/bash -c "
          echo '[TASKS] Installing dependencies in Termux'
          apt -o Acquire::Queue-Mode=access -o Acquire::Retries=3 update -y
          DEBIAN_FRONTEND=noninteractive apt -o Dpkg::Use-Pty=0 install -y --no-install-recommends \
            unstable-repo coreutils binutils procps clang curl fzf \
            libarchive readline make

          echo '[TASKS - BUILD] RUNNING TERMUX-DEBUG BUILD'
          make termux-debug

          echo '[TASKS - BUILD] BUILD COMPLETED FOR TERMUX'
        "
    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: watchdogs-termux-debug
        path: watchdogs.debug.tmux

  build-windows:
    name: Build on Windows
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install MSYS2 and MinGW-w64
      shell: powershell
      run: |
        choco install -y msys2 --params "/NoUpdate"
        refreshenv

    - name: Install build dependencies
      shell: powershell
      run: |
        $env:Path = "C:\tools\msys64\ucrt64\bin;C:\tools\msys64\usr\bin;$env:Path"
        C:\tools\msys64\usr\bin\bash.exe -lc "pacman -Syu --noconfirm"
        C:\tools\msys64\usr\bin\bash.exe -lc "pacman -S --needed --noconfirm mingw-w64-ucrt-x86_64-toolchain mingw-w64-ucrt-x86_64-clang mingw-w64-ucrt-x86_64-lld mingw-w64-ucrt-x86_64-libc++ mingw-w64-ucrt-x86_64-curl mingw-w64-ucrt-x86_64-readline mingw-w64-ucrt-x86_64-libarchive mingw-w64-ucrt-x86_64-zlib mingw-w64-ucrt-x86_64-make mingw-w64-ucrt-x86_64-windows-default-manifest"

    - name: Build using Makefile
      shell: powershell
      run: |
        $env:Path = "C:\tools\msys64\ucrt64\bin;C:\tools\msys64\usr\bin;$env:Path"
        mingw32-make windows-debug

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: watchdogs-windows-debug
        path: watchdogs.debug.win
